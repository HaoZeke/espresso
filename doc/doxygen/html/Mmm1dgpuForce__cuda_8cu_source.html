<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>ESPResSo 3.4-dev-1009-g69a2b86-dirty-git: Mmm1dgpuForce_cuda.cu Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_48x48.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">ESPResSo 3.4-dev-1009-g69a2b86-dirty-git
   </div>
   <div id="projectbrief">Extensible Simulation Package for Soft Matter Research</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Mmm1dgpuForce__cuda_8cu_source.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Mmm1dgpuForce_cuda.cu</div>  </div>
</div><!--header-->
<div class="contents">
<a href="Mmm1dgpuForce__cuda_8cu.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">  Copyright (C) 2014 The ESPResSo project</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">  This file is part of ESPResSo.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">  ESPResSo is free software: you can redistribute it and/or modify</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">  it under the terms of the GNU General Public License as published by</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">  the Free Software Foundation, either version 3 of the License, or</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">  (at your option) any later version.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">  ESPResSo is distributed in the hope that it will be useful,</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">  GNU General Public License for more details.</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">  </span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">  You should have received a copy of the GNU General Public License</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;. </span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="Mmm1dgpuForce_8hpp.html">actor/Mmm1dgpuForce.hpp</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="cuda__utils_8hpp.html">cuda_utils.hpp</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#ifdef MMM1D_GPU</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">// the code is mostly multi-GPU capable, but Espresso is not yet</span></div>
<div class="line"><a name="l00025"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a4cc83d363e002c18e179719827d5fa63">   25</a></span>&#160;<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a4cc83d363e002c18e179719827d5fa63">deviceCount</a> = 1;</div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#ab519b50a58f2a478aedbfdd0997eb9c0">   26</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ab519b50a58f2a478aedbfdd0997eb9c0">multigpu_factors</a>[] = {1.0};</div>
<div class="line"><a name="l00027"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#afc1d3fd48b33a5af56e8775cce8d5690">   27</a></span>&#160;<span class="preprocessor">#define cudaSetDevice(d)</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="mmm-common__cuda_8hpp.html">mmm-common_cuda.hpp</a>&quot;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="mmm1d_8hpp.html">mmm1d.hpp</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="interaction__data_8hpp.html">interaction_data.hpp</a>&quot;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="EspressoSystemInterface_8hpp.html">EspressoSystemInterface.hpp</a>&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#if defined(OMPI_MPI_H) || defined(_MPI_H)</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#error CU-file includes mpi.h! This should not happen!</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#ac8aa0a118c5866d8abe22a8716b48ba0">   38</a></span>&#160;__device__ <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac8aa0a118c5866d8abe22a8716b48ba0">atomicadd</a>(<span class="keywordtype">float</span>* address, <span class="keywordtype">float</span> value)</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#if !defined __CUDA_ARCH__ || __CUDA_ARCH__ &gt;= 200</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <a class="code" href="integrate__sd__cuda__device_8cu.html#a7a73685d7bc0937fcbfe8fe789d59512">atomicAdd</a>(address, value);</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#elif __CUDA_ARCH__ &gt;= 110</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        <span class="keywordtype">int</span> oldval, newval, readback;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;        oldval = __float_as_int(*address);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        newval = __float_as_int(__int_as_float(oldval) + value);</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        <span class="keywordflow">while</span> ((readback=atomicCAS((<span class="keywordtype">int</span> *)address, oldval, newval)) != oldval)</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        {</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                oldval = readback;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;                newval = __float_as_int(__int_as_float(oldval) + value);</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        }</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#error atomicAdd needs compute capability 1.1 or higher</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;}</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#aec74e88c672de4b9fbd71cb185d496ed">   56</a></span>&#160;<span class="keyword">const</span> <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aec74e88c672de4b9fbd71cb185d496ed">C_GAMMAf</a> = <a class="code" href="constraint_8cpp.html#ae1a01f66c97782ca68881e90f82761d2">C_GAMMA</a>;</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">   57</a></span>&#160;<span class="keyword">const</span> <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a> = <a class="code" href="mmm-common_8hpp.html#a0739e5d0cb51571f43e3a8aebc3d60a3">C_2PI</a>;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a272b1ae74eb9f4f602daeec525860347">   59</a></span>&#160;__constant__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a272b1ae74eb9f4f602daeec525860347">far_switch_radius_2</a> = 0.05*0.05;</div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">   60</a></span>&#160;__constant__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>;</div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">   61</a></span>&#160;__constant__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>;</div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">   62</a></span>&#160;__constant__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">coulomb_prefactor</a> = 1.0;</div>
<div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a9d1d3385bb5398ab890f6222ee3f79e7">   63</a></span>&#160;__constant__ <span class="keywordtype">int</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a9d1d3385bb5398ab890f6222ee3f79e7">bessel_cutoff</a> = 5;</div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">   64</a></span>&#160;__constant__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">maxPWerror</a> = 1e-5;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#a7394c28f6671cdb337f18ec48cffea7b">   66</a></span>&#160;<a class="code" href="classMmm1dgpuForce.html#a7394c28f6671cdb337f18ec48cffea7b">Mmm1dgpuForce::Mmm1dgpuForce</a>(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _coulomb_prefactor, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _maxPWerror,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _far_switch_radius, <span class="keywordtype">int</span> _bessel_cutoff)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;:<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">coulomb_prefactor</a>(_coulomb_prefactor), <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">maxPWerror</a>(_maxPWerror), far_switch_radius(_far_switch_radius),</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a9d1d3385bb5398ab890f6222ee3f79e7">bessel_cutoff</a>(_bessel_cutoff), host_boxz(0), host_npart(0), pairs(-1), dev_forcePairs(NULL), dev_energyBlocks(NULL),</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        numThreads(64), need_tune(true)</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;{</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="comment">// interface sanity checks</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <span class="keywordflow">if</span>(!s.<a class="code" href="classSystemInterface.html#a1f3a39b3c140df24b7cab252bbb93538">requestFGpu</a>())</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;Mmm1dgpuForce needs access to forces on GPU!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="keywordflow">if</span>(!s.<a class="code" href="classSystemInterface.html#a846b1729fa1eeaad241ae68a02f1aa24">requestRGpu</a>())</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;Mmm1dgpuForce needs access to positions on GPU!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordflow">if</span>(!s.<a class="code" href="classSystemInterface.html#aaa44dfa02ef9c7f447c62b7cbe3e8678">requestQGpu</a>())</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;Mmm1dgpuForce needs access to charges on GPU!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        <span class="comment">// system sanity checks</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        check_periodicity();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <a class="code" href="mmm-common__cuda_8hpp.html#ae54553e836693a23941379cd70d71609">modpsi_init</a>();</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;}</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#a09db60bee7e2a743a88a13636fc2a813">   88</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classMmm1dgpuForce.html#a09db60bee7e2a743a88a13636fc2a813">Mmm1dgpuForce::setup</a>(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;{</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="keywordflow">if</span> (s.<a class="code" href="classSystemInterface.html#adf9fe800476549b004ea05f0aa3eaa70">box</a>()[2] &lt;= 0)</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        {</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;Error: Please set box length before initializing MMM1D!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        }</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">if</span> (need_tune == <span class="keyword">true</span> &amp;&amp; s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>() &gt; 0)</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        {</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                <a class="code" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">set_params</a>(s.<a class="code" href="classSystemInterface.html#adf9fe800476549b004ea05f0aa3eaa70">box</a>()[2], <a class="code" href="interaction__data_8cpp.html#a6cf6e4a9cea419ad9be6212d30488c46">coulomb</a>.<a class="code" href="structCoulomb__parameters.html#a38d1cdbe75608b8fb3fb4dedf07c2c5c">prefactor</a>, maxPWerror, far_switch_radius, bessel_cutoff);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                <a class="code" href="classMmm1dgpuForce.html#a53ea2ed56a765f160a34b23fa99abef2">tune</a>(s, maxPWerror, far_switch_radius, bessel_cutoff);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        }</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="keywordflow">if</span> (s.<a class="code" href="classSystemInterface.html#adf9fe800476549b004ea05f0aa3eaa70">box</a>()[2] != host_boxz)</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;        {</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                <a class="code" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">set_params</a>(s.<a class="code" href="classSystemInterface.html#adf9fe800476549b004ea05f0aa3eaa70">box</a>()[2], 0,-1,-1,-1);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <span class="keywordflow">if</span> (s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>() == host_npart) <span class="comment">// unchanged</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        }</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="comment">// For all but the largest systems, it is faster to store force pairs and then sum them up.</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="comment">// Atomics are just so slow: so unless we&#39;re limited by memory, do the latter.</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        pairs = 2;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a4cc83d363e002c18e179719827d5fa63">deviceCount</a>; d++)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        {</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;                <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#afc1d3fd48b33a5af56e8775cce8d5690">cudaSetDevice</a>(d);</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;                <span class="keywordtype">size_t</span> freeMem, totalMem;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                cudaMemGetInfo(&amp;freeMem, &amp;totalMem);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                <span class="keywordflow">if</span> (freeMem/2 &lt; 3*s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()*s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()*<span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) <span class="comment">// don&#39;t use more than half the device&#39;s memory</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;                {</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;                        std::cerr &lt;&lt; <span class="stringliteral">&quot;Switching to atomicAdd due to memory constraints.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                        pairs = 0;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keywordflow">if</span> (dev_forcePairs)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;                cudaFree(dev_forcePairs);</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordflow">if</span> (pairs) <span class="comment">// we need memory to store force pairs</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        {</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMalloc((<span class="keywordtype">void</span>**)&amp;dev_forcePairs, 3*s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()*s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()*<span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        }</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="keywordflow">if</span> (dev_energyBlocks)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                cudaFree(dev_energyBlocks);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMalloc((<span class="keywordtype">void</span>**)&amp;dev_energyBlocks, numBlocks(s)*<span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        host_npart = s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>();</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;}</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> Mmm1dgpuForce::numBlocks(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;{</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        <span class="keywordtype">int</span> b = s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()*s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()/numThreads+1;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <span class="keywordflow">if</span> (b &gt; 65535)</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                b = 65535;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;        <span class="keywordflow">return</span> b;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;}</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#adb54cff5bc0a47e6022917698836c17f">  145</a></span>&#160;<a class="code" href="classMmm1dgpuForce.html#adb54cff5bc0a47e6022917698836c17f">Mmm1dgpuForce::~Mmm1dgpuForce</a>() {</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <a class="code" href="mmm-common__cuda_8hpp.html#a486e03181d6169eda0f80bb6c0af522d">modpsi_destroy</a>();</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        cudaFree(dev_forcePairs);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;}</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">  150</a></span>&#160;__forceinline__ __device__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> x)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;{</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">return</span> pow(x,2);</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;}</div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">  154</a></span>&#160;__forceinline__ __device__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> x)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;{</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keywordflow">return</span> pow(x,3);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;}</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#af980faab0f439ccdf8dd83d0cb093ec8">  159</a></span>&#160;__device__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af980faab0f439ccdf8dd83d0cb093ec8">sumReduction</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *input, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *sum)</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;{</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordtype">int</span> tid = threadIdx.x;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> = blockDim.x/2; <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> &gt; 0; <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> /= 2)</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                __syncthreads();</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                <span class="keywordflow">if</span> (tid &lt; <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>)</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                        input[tid] += input[<a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>+tid];</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        }</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;        __syncthreads();</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <span class="keywordflow">if</span> (tid == 0)</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                sum[0] = input[0];</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;}</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a80f8ba49f0bf2dae363676c500062983">  173</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a80f8ba49f0bf2dae363676c500062983">sumKernel</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *data, <span class="keywordtype">int</span> N)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;{</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <span class="keyword">extern</span> __shared__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> partialsums[];</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <span class="keywordflow">if</span> (blockIdx.x != 0) <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordtype">int</span> tid = threadIdx.x;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> result = 0;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; N; <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> += blockDim.x)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>+tid &gt;= N)</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                        partialsums[tid] = 0;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                        partialsums[tid] = data[<a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>+tid];</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;                </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af980faab0f439ccdf8dd83d0cb093ec8">sumReduction</a>(partialsums, &amp;result);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                <span class="keywordflow">if</span> (tid == 0)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;                {</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                        <span class="keywordflow">if</span> (<a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> == 0) data[0] = 0;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;                        data[0] += result;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                }</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        }</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;}</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div>
<div class="line"><a name="l00196"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#af20325e72379a9b295aee157cbff21a8">  196</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af20325e72379a9b295aee157cbff21a8">besselTuneKernel</a>(<span class="keywordtype">int</span> *result, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> far_switch_radius, <span class="keywordtype">int</span> maxCut)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;{</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> arg = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a>*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*far_switch_radius;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> pref = 4*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*max(1.0f, <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a>*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> <a class="code" href="cuda__common__cuda_8cu.html#ad7833076f95fefc99fc8b326ff08700f">err</a>;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="keywordtype">int</span> P = 1;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        <span class="keywordflow">do</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                err = pref*<a class="code" href="specfunc__cuda_8hpp.html#a6bfdff9c2d150cf55af8d8d4608cd6e8">dev_K1</a>(arg*P)*exp(arg)/arg*(P-1 + 1/arg);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                P++;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        } <span class="keywordflow">while</span> (err &gt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">maxPWerror</a> &amp;&amp; P &lt;= maxCut);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        P--;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        result[0] = P;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;}</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#a53ea2ed56a765f160a34b23fa99abef2">  212</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classMmm1dgpuForce.html#a53ea2ed56a765f160a34b23fa99abef2">Mmm1dgpuForce::tune</a>(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _maxPWerror, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _far_switch_radius, <span class="keywordtype">int</span> _bessel_cutoff)</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;{</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> far_switch_radius = _far_switch_radius;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;        <span class="keywordtype">int</span> bessel_cutoff = _bessel_cutoff;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> maxrad = host_boxz;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keywordflow">if</span> (_far_switch_radius &lt; 0 &amp;&amp; _bessel_cutoff &lt; 0)</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="comment">// autodetermine switching radius and bessel cutoff</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        {</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> bestrad = 0, besttime = INFINITY;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                <span class="keywordflow">for</span> (far_switch_radius = 0.05*maxrad; far_switch_radius &lt; maxrad; far_switch_radius += 0.05*maxrad)</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;                {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;                        <a class="code" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">set_params</a>(0, 0, _maxPWerror, far_switch_radius, bessel_cutoff);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                        <a class="code" href="classMmm1dgpuForce.html#a53ea2ed56a765f160a34b23fa99abef2">tune</a>(s, _maxPWerror, far_switch_radius, -2); <span class="comment">// tune bessel cutoff</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                        <span class="keywordtype">int</span> runtime = force_benchmark(s);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                        <span class="keywordflow">if</span> (runtime &lt; besttime)</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                        {</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                                besttime = runtime;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                                bestrad = far_switch_radius;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                        }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                }</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                far_switch_radius = bestrad;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                <a class="code" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">set_params</a>(0, 0, _maxPWerror, far_switch_radius, bessel_cutoff);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                <a class="code" href="classMmm1dgpuForce.html#a53ea2ed56a765f160a34b23fa99abef2">tune</a>(s, _maxPWerror, far_switch_radius, -2); <span class="comment">// tune bessel cutoff</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        }</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_bessel_cutoff &lt; 0)</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="comment">// autodetermine bessel cutoff</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                <span class="keywordtype">int</span> *dev_cutoff;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                <span class="keywordtype">int</span> maxCut = 30;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMalloc((<span class="keywordtype">void</span>**)&amp;dev_cutoff, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)) );</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;                besselTuneKernel&lt;&lt;&lt;1,1&gt;&gt;&gt;(dev_cutoff, far_switch_radius, maxCut);</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpy(&amp;bessel_cutoff, dev_cutoff, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), cudaMemcpyDeviceToHost) );</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                cudaFree(dev_cutoff);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                <span class="keywordflow">if</span> (_bessel_cutoff != -2 &amp;&amp; bessel_cutoff &gt;= maxCut) <span class="comment">// we already have our switching radius and only need to determine the cutoff, i.e. this is the final tuning round</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                {</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                        std::cerr &lt;&lt; <span class="stringliteral">&quot;No reasonable Bessel cutoff could be determined.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                        exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                }</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                <a class="code" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">set_params</a>(0, 0, _maxPWerror, far_switch_radius, bessel_cutoff);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        }</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;}</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">  259</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">Mmm1dgpuForce::set_params</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _boxz, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _coulomb_prefactor, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _maxPWerror, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _far_switch_radius, <span class="keywordtype">int</span> _bessel_cutoff, <span class="keywordtype">bool</span> manual)</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;{</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="keywordflow">if</span> (_boxz &gt; 0 &amp;&amp; _far_switch_radius &gt; _boxz)</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        {</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                std::cout &lt;&lt; <span class="stringliteral">&quot;switching radius must not be larger than box length&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        }</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _far_switch_radius_2 = _far_switch_radius*_far_switch_radius;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> _uz = 1.0/_boxz;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a4cc83d363e002c18e179719827d5fa63">deviceCount</a>; d++)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        {</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                <span class="comment">// double colons are needed to access the constant memory variables because they</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                <span class="comment">// are file globals and we have identically named class variables</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#afc1d3fd48b33a5af56e8775cce8d5690">cudaSetDevice</a>(d);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                <span class="keywordflow">if</span> (manual) <span class="comment">// tuning needs to be performed again</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                {</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                        far_switch_radius = _far_switch_radius;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                        bessel_cutoff = _bessel_cutoff;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                }</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                <span class="keywordflow">if</span> (_far_switch_radius &gt;= 0)</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                {</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                        <a class="code" href="mmm1d_8cpp.html#a614d6e075543fa7ff29fa5bd961ea488">mmm1d_params</a>.<a class="code" href="structMMM1D__struct.html#a7e6588d0ac49a13043563570ad02516f">far_switch_radius_2</a> = _far_switch_radius*_far_switch_radius;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpyToSymbol(::<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a272b1ae74eb9f4f602daeec525860347">far_switch_radius_2</a>, &amp;_far_switch_radius_2, <span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                        far_switch_radius = _far_switch_radius;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                <span class="keywordflow">if</span> (_boxz &gt; 0)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                {</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                        host_boxz = _boxz;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpyToSymbol(::<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>, &amp;_boxz, <span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpyToSymbol(::<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>, &amp;_uz, <span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                }</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                <span class="keywordflow">if</span> (_coulomb_prefactor != 0)</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                {</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;                        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpyToSymbol(::coulomb_prefactor, &amp;_coulomb_prefactor, <span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                        coulomb_prefactor = _coulomb_prefactor;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                }</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                <span class="keywordflow">if</span> (_bessel_cutoff &gt; 0)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                {</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                        <a class="code" href="mmm1d_8cpp.html#a614d6e075543fa7ff29fa5bd961ea488">mmm1d_params</a>.<a class="code" href="structMMM1D__struct.html#a4ff1e4d9df3c48a89297238b52ac1953">bessel_cutoff</a> = _bessel_cutoff;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpyToSymbol(::bessel_cutoff, &amp;_bessel_cutoff, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)) );</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;                        bessel_cutoff = _bessel_cutoff;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                }</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                <span class="keywordflow">if</span> (_maxPWerror &gt; 0)</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                {</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                        <a class="code" href="mmm1d_8cpp.html#a614d6e075543fa7ff29fa5bd961ea488">mmm1d_params</a>.<a class="code" href="structMMM1D__struct.html#ad8e91bd2215018847d3d0f8538ba75ed">maxPWerror</a> = _maxPWerror;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMemcpyToSymbol(::maxPWerror, &amp;_maxPWerror, <span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                        maxPWerror = _maxPWerror;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                }</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        need_tune = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        </div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="comment">// The changed parameters in mmm1d_params do not need to be broadcast: they are only accessed by the TCL print function (on node 0) when you call inter coulomb. The CUDA code only runs on node 0, so other nodes do not need the parameters. We couldn&#39;t broadcast from here anyway because set_params() might be called from inside computeForces() which is not a time at which the MPI loop on the slave nodes is waiting for broadcasts.</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;}</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div>
<div class="line"><a name="l00313"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a39ed5a85eb740f49186535d08af9f22d">  313</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a39ed5a85eb740f49186535d08af9f22d">forcesKernel</a>(<span class="keyword">const</span> __restrict__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *r, <span class="keyword">const</span> __restrict__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *q, __restrict__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *force, <span class="keywordtype">int</span> N, <span class="keywordtype">int</span> pairs, <span class="keywordtype">int</span> tStart = 0, <span class="keywordtype">int</span> tStop = -1)</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;{</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        <span class="keywordflow">if</span> (tStop &lt; 0)</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                tStop = N*N;</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tid = threadIdx.x + blockIdx.x * blockDim.x + tStart; tid &lt; tStop; tid += blockDim.x * gridDim.x)</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        {</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                <span class="keywordtype">int</span> p1 = tid%N, p2 = tid/N;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> x = r[3*p2] - r[3*p1], y = r[3*p2+1] - r[3*p1+1], z = r[3*p2+2] - r[3*p1+2];</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> rxy2 = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(x) + <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(y);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> rxy = sqrt(rxy2);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> sum_r = 0, sum_z = 0;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                </div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">//              if (boxz &lt;= 0.0) return; // otherwise we&#39;d get into an infinite loop if we&#39;re not initialized correctly</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                <span class="keywordflow">while</span> (fabs(z) &gt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>/2) <span class="comment">// make sure we take the shortest distance</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                        z -= (z &gt; 0? 1 : -1)*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                <span class="keywordflow">if</span> (p1 == p2) <span class="comment">// particle exerts no force on itself</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                {</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                        rxy = 1; <span class="comment">// so the division at the end doesn&#39;t fail with NaN (sum_r is 0 anyway)</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                }</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rxy2 &lt;= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a272b1ae74eb9f4f602daeec525860347">far_switch_radius_2</a>) <span class="comment">// near formula</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                {</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> uzz = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*z;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> uzr = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*rxy;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                        sum_z = <a class="code" href="mmm-common__cuda_8hpp.html#a4163865c297940b59fb2a8f4333ecd44">dev_mod_psi_odd</a>(0, uzz);</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> uzrpow = uzr;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 1; n &lt; <a class="code" href="mmm-common__cuda_8hpp.html#a96f8d51898950b5dd7decba44c8e9f4b">device_n_modPsi</a>; n++)</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                        {</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> sum_r_old = sum_r;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> mpe = <a class="code" href="mmm-common__cuda_8hpp.html#a2dbe8cb47eebbb4b700ce0acb6f743e7">dev_mod_psi_even</a>(n, uzz);</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> mpo = <a class="code" href="mmm-common__cuda_8hpp.html#a4163865c297940b59fb2a8f4333ecd44">dev_mod_psi_odd</a>(n, uzz);</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                        sum_r += 2*n*mpe * uzrpow;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                        uzrpow *= uzr;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                        sum_z += mpo * uzrpow;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                        uzrpow *= uzr;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                        <span class="keywordflow">if</span> (fabs(sum_r_old - sum_r) &lt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">maxPWerror</a>)</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                        }</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                        sum_r *= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                        sum_z *= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                        sum_r += rxy*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(rsqrt(rxy2+pow(z,2)));</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                        sum_r += rxy*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(rsqrt(rxy2+pow(z+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>,2)));</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                        sum_r += rxy*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(rsqrt(rxy2+pow(z-<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>,2)));</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                        sum_z += z*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(rsqrt(rxy2+pow(z,2)));</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                        sum_z += (z+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>)*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(rsqrt(rxy2+pow(z+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>,2)));</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                        sum_z += (z-<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>)*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a>(rsqrt(rxy2+pow(z-<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>,2)));</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                        <span class="keywordflow">if</span> (rxy == 0) <span class="comment">// particles at the same radial position only exert a force in z direction</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                        {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                                rxy = 1;  <span class="comment">// so the division at the end doesn&#39;t fail with NaN (sum_r is 0 anyway)</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                        }</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                <span class="keywordflow">else</span> <span class="comment">// far formula</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = 1; p &lt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a9d1d3385bb5398ab890f6222ee3f79e7">bessel_cutoff</a>; p++)</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                        {</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> arg = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a>*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*p;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                                sum_r += p*<a class="code" href="specfunc__cuda_8hpp.html#a6bfdff9c2d150cf55af8d8d4608cd6e8">dev_K1</a>(arg*rxy)*cos(arg*z);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                                sum_z += p*<a class="code" href="specfunc__cuda_8hpp.html#a37c862e2baaaf70db22edc8444c0fb43">dev_K0</a>(arg*rxy)*sin(arg*z);</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                        }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                        sum_r *= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>)*4*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a>;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                        sum_z *= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>)*4*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a>;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                        sum_r += 2*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>/rxy;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                }</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> pref = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">coulomb_prefactor</a>*q[p1]*q[p2];</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                <span class="keywordflow">if</span> (pairs)</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                        force[3*(p1+p2*N-tStart)] = pref*sum_r/rxy*x;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                        force[3*(p1+p2*N-tStart)+1] = pref*sum_r/rxy*y;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                        force[3*(p1+p2*N-tStart)+2] = pref*sum_z;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                }</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                {</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="preprocessor">#ifdef ELECTROSTATICS_GPU_DOUBLE_PRECISION</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                        atomicadd8(&amp;force[3*p2], pref*sum_r/rxy*x);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                        atomicadd8(&amp;force[3*p2+1], pref*sum_r/rxy*y);</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                        atomicadd8(&amp;force[3*p2+2], pref*sum_z);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                        <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac8aa0a118c5866d8abe22a8716b48ba0">atomicadd</a>(&amp;force[3*p2], pref*sum_r/rxy*x);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                        <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac8aa0a118c5866d8abe22a8716b48ba0">atomicadd</a>(&amp;force[3*p2+1], pref*sum_r/rxy*y);</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                        <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac8aa0a118c5866d8abe22a8716b48ba0">atomicadd</a>(&amp;force[3*p2+2], pref*sum_z);</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                }</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        }</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div>
<div class="line"><a name="l00407"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a8d6ed6ceeff47e1a66d2eb0d6df4e884">  407</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a8d6ed6ceeff47e1a66d2eb0d6df4e884">energiesKernel</a>(<span class="keyword">const</span> __restrict__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *r, <span class="keyword">const</span> __restrict__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *q, __restrict__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *<a class="code" href="energy_8cpp.html#aef336d38edfed93bb9f920665af1083c">energy</a>, <span class="keywordtype">int</span> N, <span class="keywordtype">int</span> pairs, <span class="keywordtype">int</span> tStart = 0, <span class="keywordtype">int</span> tStop = -1)</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;{</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordflow">if</span> (tStop &lt; 0)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                tStop = N*N;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="keyword">extern</span> __shared__ <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> partialsums[];</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        <span class="keywordflow">if</span> (!pairs)</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        {</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                partialsums[threadIdx.x] = 0;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                __syncthreads();</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        }</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tid = threadIdx.x + blockIdx.x * blockDim.x + tStart; tid &lt; tStop; tid += blockDim.x * gridDim.x)</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        {</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                <span class="keywordtype">int</span> p1 = tid%N, p2 = tid/N;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> z = r[3*p2+2] - r[3*p1+2];</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> rxy2 = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(r[3*p2] - r[3*p1]) + <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(r[3*p2+1] - r[3*p1+1]);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> rxy = sqrt(rxy2);</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> sum_e = 0;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">//              if (boxz &lt;= 0.0) return; // otherwise we&#39;d get into an infinite loop if we&#39;re not initialized correctly</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                <span class="keywordflow">while</span> (fabs(z) &gt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>/2) <span class="comment">// make sure we take the shortest distance</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        z -= (z &gt; 0? 1 : -1)*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                <span class="keywordflow">if</span> (p1 == p2) <span class="comment">// particle exerts no force on itself</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                }</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rxy2 &lt;= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a272b1ae74eb9f4f602daeec525860347">far_switch_radius_2</a>) <span class="comment">// near formula</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                {</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> uzz = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*z;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> uzr2 = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*rxy);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> uzrpow = uzr2;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                        sum_e = <a class="code" href="mmm-common__cuda_8hpp.html#a2dbe8cb47eebbb4b700ce0acb6f743e7">dev_mod_psi_even</a>(0, uzz);</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 1; n &lt; <a class="code" href="mmm-common__cuda_8hpp.html#a96f8d51898950b5dd7decba44c8e9f4b">device_n_modPsi</a>; n++)</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                        {</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> sum_e_old = sum_e;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> mpe = <a class="code" href="mmm-common__cuda_8hpp.html#a2dbe8cb47eebbb4b700ce0acb6f743e7">dev_mod_psi_even</a>(n, uzz);</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                        sum_e += mpe * uzrpow;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                        uzrpow *= uzr2;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                                </div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                                <span class="keywordflow">if</span> (fabs(sum_e_old - sum_e) &lt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">maxPWerror</a>)</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;                        }</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                        sum_e *= -1*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                        sum_e -= 2*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aec74e88c672de4b9fbd71cb185d496ed">C_GAMMAf</a>;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                        sum_e += rsqrt(rxy2+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(z));</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                        sum_e += rsqrt(rxy2+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(z+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>));</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                        sum_e += rsqrt(rxy2+<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a>(z-<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a>));</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                }</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;                <span class="keywordflow">else</span> <span class="comment">// far formula</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                        sum_e = -(log(rxy*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>/2) + <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#aec74e88c672de4b9fbd71cb185d496ed">C_GAMMAf</a>)/2;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p = 1; p &lt; <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a9d1d3385bb5398ab890f6222ee3f79e7">bessel_cutoff</a>; p++)</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;                        {</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                                <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> arg = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a>*<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*p;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                                sum_e += <a class="code" href="specfunc__cuda_8hpp.html#a37c862e2baaaf70db22edc8444c0fb43">dev_K0</a>(arg*rxy)*cos(arg*z);</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                        }</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;                        sum_e *= <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a>*4;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                }</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                <span class="keywordflow">if</span> (pairs)</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;                {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                        energy[p1+p2*N-tStart] = <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">coulomb_prefactor</a>*q[p1]*q[p2]*sum_e;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                }</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                {</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                        partialsums[threadIdx.x] += <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">coulomb_prefactor</a>*q[p1]*q[p2]*sum_e;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                }</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        }</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="keywordflow">if</span> (!pairs)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        {</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#af980faab0f439ccdf8dd83d0cb093ec8">sumReduction</a>(partialsums, &amp;energy[blockIdx.x]);</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        }</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;}</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div>
<div class="line"><a name="l00483"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a144d22d6a59b1a5c7c3909a98544df53">  483</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a144d22d6a59b1a5c7c3909a98544df53">vectorReductionKernel</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *src, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *dst, <span class="keywordtype">int</span> N, <span class="keywordtype">int</span> tStart = 0, <span class="keywordtype">int</span> tStop = -1)</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;{</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <span class="keywordflow">if</span> (tStop &lt; 0)</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;                tStop = N*N;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tid = threadIdx.x + blockIdx.x * blockDim.x; tid &lt; N; tid += blockDim.x * gridDim.x)</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        {</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                <span class="keywordtype">int</span> offset = ((tid + (tStart % N)) % N);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                </div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; tid+<a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>*N &lt; (tStop - tStart); <a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                {</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="preprocessor">                        #pragma unroll 3</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d&lt;3; d++)</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                        {</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                                dst[3*offset+d] -= src[3*(tid+<a class="code" href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>*N)+d];</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                        }</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                }</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;}</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div>
<div class="line"><a name="l00503"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#ad005451c5e3ee94e046badf9009886be">  503</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classMmm1dgpuForce.html#ad005451c5e3ee94e046badf9009886be">Mmm1dgpuForce::computeForces</a>(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s)</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;{</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="interaction__data_8cpp.html#a6cf6e4a9cea419ad9be6212d30488c46">coulomb</a>.<a class="code" href="structCoulomb__parameters.html#a91e49bd10162ccc14beff4a244d905ec">method</a> != <a class="code" href="interaction__data_8hpp.html#aff5199c0965a1903845b2c4e4eddbf96af540dbc00e6ca3d796715665beb13826">COULOMB_MMM1D_GPU</a>) <span class="comment">// MMM1DGPU was disabled. nobody cares about our calculations anymore</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        {</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;MMM1D: coulomb.method has been changed, skipping calculation&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        }</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        <a class="code" href="classMmm1dgpuForce.html#a09db60bee7e2a743a88a13636fc2a813">setup</a>(s);</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">if</span> (pairs &lt; 0)</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        {</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;MMM1D was not initialized correctly&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;                exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        }</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        <span class="keywordflow">if</span> (pairs) <span class="comment">// if we calculate force pairs, we need to reduce them to forces</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        {</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                <span class="keywordtype">int</span> blocksRed = s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()/numThreads+1;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;                <a class="code" href="cuda__utils_8hpp.html#a29bd11db4afd37d9dd44dc3c522b5dd3">KERNELCALL</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a39ed5a85eb740f49186535d08af9f22d">forcesKernel</a>,numBlocks(s),numThreads,(s.<a class="code" href="classSystemInterface.html#a1570b83c24862911fec6664bbee224a0">rGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#a5ed43e2950602e1707daa49862f7858b">qGpuBegin</a>(), dev_forcePairs, s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>(), pairs))</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                <a class="code" href="cuda__utils_8hpp.html#a29bd11db4afd37d9dd44dc3c522b5dd3">KERNELCALL</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a144d22d6a59b1a5c7c3909a98544df53">vectorReductionKernel</a>,blocksRed,numThreads,(dev_forcePairs, s.<a class="code" href="classSystemInterface.html#a41579893b249ff1ff6df6f385104f4b0">fGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()))</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        }</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        {</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                <a class="code" href="cuda__utils_8hpp.html#a29bd11db4afd37d9dd44dc3c522b5dd3">KERNELCALL</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a39ed5a85eb740f49186535d08af9f22d">forcesKernel</a>,numBlocks(s),numThreads,(s.<a class="code" href="classSystemInterface.html#a1570b83c24862911fec6664bbee224a0">rGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#a5ed43e2950602e1707daa49862f7858b">qGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#a41579893b249ff1ff6df6f385104f4b0">fGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>(), pairs))</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        }</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;}</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div>
<div class="line"><a name="l00530"></a><span class="lineno"><a class="line" href="Mmm1dgpuForce__cuda_8cu.html#a0db5bed3a5116c143149d41cbddfb221">  530</a></span>&#160;__global__ <span class="keywordtype">void</span> <a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0db5bed3a5116c143149d41cbddfb221">scaleAndAddKernel</a>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *dst, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *src, <span class="keywordtype">int</span> N, <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> factor)</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;{</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tid = threadIdx.x + blockIdx.x * blockDim.x; tid &lt; N; tid += blockDim.x * gridDim.x)</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        {</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                dst[tid] += src[tid]*factor;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        }</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;}</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div>
<div class="line"><a name="l00538"></a><span class="lineno"><a class="line" href="classMmm1dgpuForce.html#aab29f6175a147363ebfe6bf8ae2de6f4">  538</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classMmm1dgpuForce.html#aab29f6175a147363ebfe6bf8ae2de6f4">Mmm1dgpuForce::computeEnergy</a>(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s)</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;{</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="interaction__data_8cpp.html#a6cf6e4a9cea419ad9be6212d30488c46">coulomb</a>.<a class="code" href="structCoulomb__parameters.html#a91e49bd10162ccc14beff4a244d905ec">method</a> != <a class="code" href="interaction__data_8hpp.html#aff5199c0965a1903845b2c4e4eddbf96af540dbc00e6ca3d796715665beb13826">COULOMB_MMM1D_GPU</a>) <span class="comment">// MMM1DGPU was disabled. nobody cares about our calculations anymore</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        {</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;MMM1D: coulomb.method has been changed, skipping calculation&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        }</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;        <a class="code" href="classMmm1dgpuForce.html#a09db60bee7e2a743a88a13636fc2a813">setup</a>(s);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="keywordflow">if</span> (pairs &lt; 0)</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        {</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                std::cerr &lt;&lt; <span class="stringliteral">&quot;MMM1D was not initialized correctly&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        }</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="keywordtype">int</span> shared = numThreads*<span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>);</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a850d20a34ccbc585c6b1f5bf23a718be">KERNELCALL_shared</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a8d6ed6ceeff47e1a66d2eb0d6df4e884">energiesKernel</a>,numBlocks(s),numThreads,shared,(s.<a class="code" href="classSystemInterface.html#a1570b83c24862911fec6664bbee224a0">rGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#a5ed43e2950602e1707daa49862f7858b">qGpuBegin</a>(), dev_energyBlocks, s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>(), 0));</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a850d20a34ccbc585c6b1f5bf23a718be">KERNELCALL_shared</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a80f8ba49f0bf2dae363676c500062983">sumKernel</a>,1,numThreads,shared,(dev_energyBlocks, numBlocks(s)));</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a29bd11db4afd37d9dd44dc3c522b5dd3">KERNELCALL</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a0db5bed3a5116c143149d41cbddfb221">scaleAndAddKernel</a>,1,1,(&amp;(((CUDA_energy*)s.<a class="code" href="classSystemInterface.html#a79ed4eed22c220d6b7e18f341881b1cd">eGpu</a>())-&gt;<a class="code" href="interaction__data_8cpp.html#a6cf6e4a9cea419ad9be6212d30488c46">coulomb</a>), &amp;dev_energyBlocks[0], 1, 0.5)); <span class="comment">// we have counted every interaction twice, so halve the total energy</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;}</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordtype">float</span> Mmm1dgpuForce::force_benchmark(<a class="code" href="classSystemInterface.html">SystemInterface</a> &amp;s)</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;{</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        cudaEvent_t eventStart, eventStop;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <span class="keywordtype">float</span> elapsedTime;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a> *dev_f_benchmark;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaMalloc((<span class="keywordtype">void</span>**)&amp;dev_f_benchmark, 3*s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>()*<span class="keyword">sizeof</span>(<a class="code" href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a>)) );</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventCreate(&amp;eventStart) );</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventCreate(&amp;eventStop) );</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventRecord(eventStart, <a class="code" href="cuda__common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">stream</a>[0]) );</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a29bd11db4afd37d9dd44dc3c522b5dd3">KERNELCALL</a>(<a class="code" href="Mmm1dgpuForce__cuda_8cu.html#a39ed5a85eb740f49186535d08af9f22d">forcesKernel</a>,numBlocks(s),numThreads,(s.<a class="code" href="classSystemInterface.html#a1570b83c24862911fec6664bbee224a0">rGpuBegin</a>(), s.<a class="code" href="classSystemInterface.html#a5ed43e2950602e1707daa49862f7858b">qGpuBegin</a>(), dev_f_benchmark, s.<a class="code" href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">npart_gpu</a>(), 0))</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventRecord(eventStop, <a class="code" href="cuda__common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">stream</a>[0]) );</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventSynchronize(eventStop) );</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventElapsedTime(&amp;elapsedTime, eventStart, eventStop) );</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventDestroy(eventStart) );</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaEventDestroy(eventStop) );</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        <a class="code" href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a>( cudaFree(dev_f_benchmark));</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;        return elapsedTime;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;}</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* MMM1D_GPU */</span><span class="preprocessor"></span></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_ac9beeffff137ff4bc24698134bcead87"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#ac9beeffff137ff4bc24698134bcead87">boxz</a></div><div class="ttdeci">__constant__ mmm1dgpu_real boxz</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00060">Mmm1dgpuForce_cuda.cu:60</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a9d1d3385bb5398ab890f6222ee3f79e7"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a9d1d3385bb5398ab890f6222ee3f79e7">bessel_cutoff</a></div><div class="ttdeci">__constant__ int bessel_cutoff</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00063">Mmm1dgpuForce_cuda.cu:63</a></div></div>
<div class="ttc" id="integrate__sd__cuda__device_8cu_html_a7a73685d7bc0937fcbfe8fe789d59512"><div class="ttname"><a href="integrate__sd__cuda__device_8cu.html#a7a73685d7bc0937fcbfe8fe789d59512">atomicAdd</a></div><div class="ttdeci">__device__ double atomicAdd(double *address, double inc)</div><div class="ttdoc">atomic add for doubles address : pointer to which the value should be added inc : value which should ...</div><div class="ttdef"><b>Definition:</b> <a href="integrate__sd__cuda__device_8cu_source.html#l00034">integrate_sd_cuda_device.cu:34</a></div></div>
<div class="ttc" id="mmm-common__cuda_8hpp_html"><div class="ttname"><a href="mmm-common__cuda_8hpp.html">mmm-common_cuda.hpp</a></div></div>
<div class="ttc" id="classSystemInterface_html_a41579893b249ff1ff6df6f385104f4b0"><div class="ttname"><a href="classSystemInterface.html#a41579893b249ff1ff6df6f385104f4b0">SystemInterface::fGpuBegin</a></div><div class="ttdeci">virtual float * fGpuBegin()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00130">SystemInterface.hpp:130</a></div></div>
<div class="ttc" id="mmm1d_8cpp_html_a614d6e075543fa7ff29fa5bd961ea488"><div class="ttname"><a href="mmm1d_8cpp.html#a614d6e075543fa7ff29fa5bd961ea488">mmm1d_params</a></div><div class="ttdeci">MMM1D_struct mmm1d_params</div><div class="ttdef"><b>Definition:</b> <a href="mmm1d_8cpp_source.html#l00065">mmm1d.cpp:65</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_ad005451c5e3ee94e046badf9009886be"><div class="ttname"><a href="classMmm1dgpuForce.html#ad005451c5e3ee94e046badf9009886be">Mmm1dgpuForce::computeForces</a></div><div class="ttdeci">void computeForces(SystemInterface &amp;s)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00503">Mmm1dgpuForce_cuda.cu:503</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_af702e9df54d3be3ce9c94d169284a12a"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#af702e9df54d3be3ce9c94d169284a12a">sqpow</a></div><div class="ttdeci">__forceinline__ __device__ mmm1dgpu_real sqpow(mmm1dgpu_real x)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00150">Mmm1dgpuForce_cuda.cu:150</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_aac7362ac305f28d0091845e6ec7d2357"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#aac7362ac305f28d0091845e6ec7d2357">cbpow</a></div><div class="ttdeci">__forceinline__ __device__ mmm1dgpu_real cbpow(mmm1dgpu_real x)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00154">Mmm1dgpuForce_cuda.cu:154</a></div></div>
<div class="ttc" id="classSystemInterface_html_a1570b83c24862911fec6664bbee224a0"><div class="ttname"><a href="classSystemInterface.html#a1570b83c24862911fec6664bbee224a0">SystemInterface::rGpuBegin</a></div><div class="ttdeci">virtual float * rGpuBegin()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00115">SystemInterface.hpp:115</a></div></div>
<div class="ttc" id="interaction__data_8hpp_html_aff5199c0965a1903845b2c4e4eddbf96af540dbc00e6ca3d796715665beb13826"><div class="ttname"><a href="interaction__data_8hpp.html#aff5199c0965a1903845b2c4e4eddbf96af540dbc00e6ca3d796715665beb13826">COULOMB_MMM1D_GPU</a></div><div class="ttdef"><b>Definition:</b> <a href="interaction__data_8hpp_source.html#l00148">interaction_data.hpp:148</a></div></div>
<div class="ttc" id="classSystemInterface_html_a79ed4eed22c220d6b7e18f341881b1cd"><div class="ttname"><a href="classSystemInterface.html#a79ed4eed22c220d6b7e18f341881b1cd">SystemInterface::eGpu</a></div><div class="ttdeci">virtual float * eGpu()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00132">SystemInterface.hpp:132</a></div></div>
<div class="ttc" id="constraint_8cpp_html_ae1a01f66c97782ca68881e90f82761d2"><div class="ttname"><a href="constraint_8cpp.html#ae1a01f66c97782ca68881e90f82761d2">C_GAMMA</a></div><div class="ttdeci">#define C_GAMMA</div><div class="ttdef"><b>Definition:</b> <a href="constraint_8cpp_source.html#l00032">constraint.cpp:32</a></div></div>
<div class="ttc" id="cuda__utils_8hpp_html_a29bd11db4afd37d9dd44dc3c522b5dd3"><div class="ttname"><a href="cuda__utils_8hpp.html#a29bd11db4afd37d9dd44dc3c522b5dd3">KERNELCALL</a></div><div class="ttdeci">#define KERNELCALL(_f, _a, _b, _params)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__utils_8hpp_source.html#l00056">cuda_utils.hpp:56</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_ab519b50a58f2a478aedbfdd0997eb9c0"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#ab519b50a58f2a478aedbfdd0997eb9c0">multigpu_factors</a></div><div class="ttdeci">float multigpu_factors[]</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00026">Mmm1dgpuForce_cuda.cu:26</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a4cc83d363e002c18e179719827d5fa63"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a4cc83d363e002c18e179719827d5fa63">deviceCount</a></div><div class="ttdeci">const int deviceCount</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00025">Mmm1dgpuForce_cuda.cu:25</a></div></div>
<div class="ttc" id="classSystemInterface_html_aaa44dfa02ef9c7f447c62b7cbe3e8678"><div class="ttname"><a href="classSystemInterface.html#aaa44dfa02ef9c7f447c62b7cbe3e8678">SystemInterface::requestQGpu</a></div><div class="ttdeci">virtual bool requestQGpu()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00128">SystemInterface.hpp:128</a></div></div>
<div class="ttc" id="structMMM1D__struct_html_ad8e91bd2215018847d3d0f8538ba75ed"><div class="ttname"><a href="structMMM1D__struct.html#ad8e91bd2215018847d3d0f8538ba75ed">MMM1D_struct::maxPWerror</a></div><div class="ttdeci">double maxPWerror</div><div class="ttdoc">required accuracy </div><div class="ttdef"><b>Definition:</b> <a href="mmm1d_8hpp_source.html#l00042">mmm1d.hpp:42</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_af20325e72379a9b295aee157cbff21a8"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#af20325e72379a9b295aee157cbff21a8">besselTuneKernel</a></div><div class="ttdeci">__global__ void besselTuneKernel(int *result, mmm1dgpu_real far_switch_radius, int maxCut)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00196">Mmm1dgpuForce_cuda.cu:196</a></div></div>
<div class="ttc" id="lbgpu_8cpp_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="lbgpu_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="lbgpu_8cpp_source.html#l00161">lbgpu.cpp:161</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_aec74e88c672de4b9fbd71cb185d496ed"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#aec74e88c672de4b9fbd71cb185d496ed">C_GAMMAf</a></div><div class="ttdeci">const mmm1dgpu_real C_GAMMAf</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00056">Mmm1dgpuForce_cuda.cu:56</a></div></div>
<div class="ttc" id="mmm-common__cuda_8hpp_html_a2dbe8cb47eebbb4b700ce0acb6f743e7"><div class="ttname"><a href="mmm-common__cuda_8hpp.html#a2dbe8cb47eebbb4b700ce0acb6f743e7">dev_mod_psi_even</a></div><div class="ttdeci">__device__ mmm1dgpu_real dev_mod_psi_even(int n, mmm1dgpu_real x)</div><div class="ttdef"><b>Definition:</b> <a href="mmm-common__cuda_8hpp_source.html#l00098">mmm-common_cuda.hpp:98</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a8d6ed6ceeff47e1a66d2eb0d6df4e884"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a8d6ed6ceeff47e1a66d2eb0d6df4e884">energiesKernel</a></div><div class="ttdeci">__global__ void energiesKernel(const __restrict__ mmm1dgpu_real *r, const __restrict__ mmm1dgpu_real *q, __restrict__ mmm1dgpu_real *energy, int N, int pairs, int tStart=0, int tStop=-1)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00407">Mmm1dgpuForce_cuda.cu:407</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a0db5bed3a5116c143149d41cbddfb221"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a0db5bed3a5116c143149d41cbddfb221">scaleAndAddKernel</a></div><div class="ttdeci">__global__ void scaleAndAddKernel(mmm1dgpu_real *dst, mmm1dgpu_real *src, int N, mmm1dgpu_real factor)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00530">Mmm1dgpuForce_cuda.cu:530</a></div></div>
<div class="ttc" id="cuda__common__cuda_8cu_html_a2edcfbb6549e85581562bf5ed89d2008"><div class="ttname"><a href="cuda__common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">stream</a></div><div class="ttdeci">cudaStream_t stream[1]</div><div class="ttdoc">cuda streams for parallel computing on cpu and gpu </div><div class="ttdef"><b>Definition:</b> <a href="cuda__common__cuda_8cu_source.html#l00056">cuda_common_cuda.cu:56</a></div></div>
<div class="ttc" id="structCoulomb__parameters_html_a38d1cdbe75608b8fb3fb4dedf07c2c5c"><div class="ttname"><a href="structCoulomb__parameters.html#a38d1cdbe75608b8fb3fb4dedf07c2c5c">Coulomb_parameters::prefactor</a></div><div class="ttdeci">double prefactor</div><div class="ttdoc">bjerrum length times temperature. </div><div class="ttdef"><b>Definition:</b> <a href="interaction__data_8hpp_source.html#l00524">interaction_data.hpp:524</a></div></div>
<div class="ttc" id="mmm-common__cuda_8hpp_html_ae54553e836693a23941379cd70d71609"><div class="ttname"><a href="mmm-common__cuda_8hpp.html#ae54553e836693a23941379cd70d71609">modpsi_init</a></div><div class="ttdeci">int modpsi_init()</div><div class="ttdef"><b>Definition:</b> <a href="mmm-common__cuda_8hpp_source.html#l00038">mmm-common_cuda.hpp:38</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_a09db60bee7e2a743a88a13636fc2a813"><div class="ttname"><a href="classMmm1dgpuForce.html#a09db60bee7e2a743a88a13636fc2a813">Mmm1dgpuForce::setup</a></div><div class="ttdeci">void setup(SystemInterface &amp;s)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00088">Mmm1dgpuForce_cuda.cu:88</a></div></div>
<div class="ttc" id="cuda__utils_8hpp_html_a725cc96b2e195dbe5b09f3b4edc2fbcb"><div class="ttname"><a href="cuda__utils_8hpp.html#a725cc96b2e195dbe5b09f3b4edc2fbcb">cuda_safe_mem</a></div><div class="ttdeci">#define cuda_safe_mem(a)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__utils_8hpp_source.html#l00046">cuda_utils.hpp:46</a></div></div>
<div class="ttc" id="classSystemInterface_html_a846b1729fa1eeaad241ae68a02f1aa24"><div class="ttname"><a href="classSystemInterface.html#a846b1729fa1eeaad241ae68a02f1aa24">SystemInterface::requestRGpu</a></div><div class="ttdeci">virtual bool requestRGpu()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00118">SystemInterface.hpp:118</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a144d22d6a59b1a5c7c3909a98544df53"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a144d22d6a59b1a5c7c3909a98544df53">vectorReductionKernel</a></div><div class="ttdeci">__global__ void vectorReductionKernel(mmm1dgpu_real *src, mmm1dgpu_real *dst, int N, int tStart=0, int tStop=-1)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00483">Mmm1dgpuForce_cuda.cu:483</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_af980faab0f439ccdf8dd83d0cb093ec8"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#af980faab0f439ccdf8dd83d0cb093ec8">sumReduction</a></div><div class="ttdeci">__device__ void sumReduction(mmm1dgpu_real *input, mmm1dgpu_real *sum)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00159">Mmm1dgpuForce_cuda.cu:159</a></div></div>
<div class="ttc" id="classSystemInterface_html_acae87fd6fb3542fe5fe56121b586af0b"><div class="ttname"><a href="classSystemInterface.html#acae87fd6fb3542fe5fe56121b586af0b">SystemInterface::npart_gpu</a></div><div class="ttdeci">virtual unsigned int npart_gpu()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00157">SystemInterface.hpp:157</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_adb54cff5bc0a47e6022917698836c17f"><div class="ttname"><a href="classMmm1dgpuForce.html#adb54cff5bc0a47e6022917698836c17f">Mmm1dgpuForce::~Mmm1dgpuForce</a></div><div class="ttdeci">~Mmm1dgpuForce()</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00145">Mmm1dgpuForce_cuda.cu:145</a></div></div>
<div class="ttc" id="Mmm1dgpuForce_8hpp_html"><div class="ttname"><a href="Mmm1dgpuForce_8hpp.html">Mmm1dgpuForce.hpp</a></div></div>
<div class="ttc" id="mmm-common__cuda_8hpp_html_a4163865c297940b59fb2a8f4333ecd44"><div class="ttname"><a href="mmm-common__cuda_8hpp.html#a4163865c297940b59fb2a8f4333ecd44">dev_mod_psi_odd</a></div><div class="ttdeci">__device__ mmm1dgpu_real dev_mod_psi_odd(int n, mmm1dgpu_real x)</div><div class="ttdef"><b>Definition:</b> <a href="mmm-common__cuda_8hpp_source.html#l00104">mmm-common_cuda.hpp:104</a></div></div>
<div class="ttc" id="mmm1d_8hpp_html"><div class="ttname"><a href="mmm1d_8hpp.html">mmm1d.hpp</a></div><div class="ttdoc">MMM1D algorithm for long range coulomb interactions. </div></div>
<div class="ttc" id="classSystemInterface_html_a5ed43e2950602e1707daa49862f7858b"><div class="ttname"><a href="classSystemInterface.html#a5ed43e2950602e1707daa49862f7858b">SystemInterface::qGpuBegin</a></div><div class="ttdeci">virtual float * qGpuBegin()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00125">SystemInterface.hpp:125</a></div></div>
<div class="ttc" id="structMMM1D__struct_html_a4ff1e4d9df3c48a89297238b52ac1953"><div class="ttname"><a href="structMMM1D__struct.html#a4ff1e4d9df3c48a89297238b52ac1953">MMM1D_struct::bessel_cutoff</a></div><div class="ttdeci">int bessel_cutoff</div><div class="ttdoc">cutoff of the bessel sum. </div><div class="ttdef"><b>Definition:</b> <a href="mmm1d_8hpp_source.html#l00044">mmm1d.hpp:44</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a5192286aec740847afb042a1f5f78b91"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a5192286aec740847afb042a1f5f78b91">uz</a></div><div class="ttdeci">__constant__ mmm1dgpu_real uz</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00061">Mmm1dgpuForce_cuda.cu:61</a></div></div>
<div class="ttc" id="cuda__utils_8hpp_html"><div class="ttname"><a href="cuda__utils_8hpp.html">cuda_utils.hpp</a></div></div>
<div class="ttc" id="specfunc__cuda_8hpp_html_a37c862e2baaaf70db22edc8444c0fb43"><div class="ttname"><a href="specfunc__cuda_8hpp.html#a37c862e2baaaf70db22edc8444c0fb43">dev_K0</a></div><div class="ttdeci">__device__ mmm1dgpu_real dev_K0(mmm1dgpu_real x)</div><div class="ttdef"><b>Definition:</b> <a href="specfunc__cuda_8hpp_source.html#l00187">specfunc_cuda.hpp:187</a></div></div>
<div class="ttc" id="cuda__utils_8hpp_html_a850d20a34ccbc585c6b1f5bf23a718be"><div class="ttname"><a href="cuda__utils_8hpp.html#a850d20a34ccbc585c6b1f5bf23a718be">KERNELCALL_shared</a></div><div class="ttdeci">#define KERNELCALL_shared(_f, _a, _b, _s, _params)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__utils_8hpp_source.html#l00048">cuda_utils.hpp:48</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_a53ea2ed56a765f160a34b23fa99abef2"><div class="ttname"><a href="classMmm1dgpuForce.html#a53ea2ed56a765f160a34b23fa99abef2">Mmm1dgpuForce::tune</a></div><div class="ttdeci">void tune(SystemInterface &amp;s, mmm1dgpu_real _maxPWerror, mmm1dgpu_real _far_switch_radius, int _bessel_cutoff)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00212">Mmm1dgpuForce_cuda.cu:212</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a0fa30246e5df7095ba958733bb5a56d8"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a0fa30246e5df7095ba958733bb5a56d8">C_2PIf</a></div><div class="ttdeci">const mmm1dgpu_real C_2PIf</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00057">Mmm1dgpuForce_cuda.cu:57</a></div></div>
<div class="ttc" id="interaction__data_8cpp_html_a6cf6e4a9cea419ad9be6212d30488c46"><div class="ttname"><a href="interaction__data_8cpp.html#a6cf6e4a9cea419ad9be6212d30488c46">coulomb</a></div><div class="ttdeci">Coulomb_parameters coulomb</div><div class="ttdoc">Structure containing the coulomb parameters. </div><div class="ttdef"><b>Definition:</b> <a href="interaction__data_8cpp_source.html#l00075">interaction_data.cpp:75</a></div></div>
<div class="ttc" id="classSystemInterface_html_a1f3a39b3c140df24b7cab252bbb93538"><div class="ttname"><a href="classSystemInterface.html#a1f3a39b3c140df24b7cab252bbb93538">SystemInterface::requestFGpu</a></div><div class="ttdeci">virtual bool requestFGpu()</div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00134">SystemInterface.hpp:134</a></div></div>
<div class="ttc" id="mmm-common__cuda_8hpp_html_a486e03181d6169eda0f80bb6c0af522d"><div class="ttname"><a href="mmm-common__cuda_8hpp.html#a486e03181d6169eda0f80bb6c0af522d">modpsi_destroy</a></div><div class="ttdeci">int modpsi_destroy()</div><div class="ttdef"><b>Definition:</b> <a href="mmm-common__cuda_8hpp_source.html#l00085">mmm-common_cuda.hpp:85</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_ae64910044d1d8f3cc7c1dd5612b7252d"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#ae64910044d1d8f3cc7c1dd5612b7252d">maxPWerror</a></div><div class="ttdeci">__constant__ mmm1dgpu_real maxPWerror</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00064">Mmm1dgpuForce_cuda.cu:64</a></div></div>
<div class="ttc" id="specfunc__cuda_8hpp_html_a6bfdff9c2d150cf55af8d8d4608cd6e8"><div class="ttname"><a href="specfunc__cuda_8hpp.html#a6bfdff9c2d150cf55af8d8d4608cd6e8">dev_K1</a></div><div class="ttdeci">__device__ mmm1dgpu_real dev_K1(mmm1dgpu_real x)</div><div class="ttdef"><b>Definition:</b> <a href="specfunc__cuda_8hpp_source.html#l00201">specfunc_cuda.hpp:201</a></div></div>
<div class="ttc" id="mmm-common__cuda_8hpp_html_a96f8d51898950b5dd7decba44c8e9f4b"><div class="ttname"><a href="mmm-common__cuda_8hpp.html#a96f8d51898950b5dd7decba44c8e9f4b">device_n_modPsi</a></div><div class="ttdeci">__constant__ int device_n_modPsi</div><div class="ttdef"><b>Definition:</b> <a href="mmm-common__cuda_8hpp_source.html#l00034">mmm-common_cuda.hpp:34</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_a7394c28f6671cdb337f18ec48cffea7b"><div class="ttname"><a href="classMmm1dgpuForce.html#a7394c28f6671cdb337f18ec48cffea7b">Mmm1dgpuForce::Mmm1dgpuForce</a></div><div class="ttdeci">Mmm1dgpuForce(SystemInterface &amp;s, mmm1dgpu_real coulomb_prefactor, mmm1dgpu_real maxPWerror, mmm1dgpu_real far_switch_radius=-1, int bessel_cutoff=-1)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00066">Mmm1dgpuForce_cuda.cu:66</a></div></div>
<div class="ttc" id="energy_8cpp_html_aef336d38edfed93bb9f920665af1083c"><div class="ttname"><a href="energy_8cpp.html#aef336d38edfed93bb9f920665af1083c">energy</a></div><div class="ttdeci">Observable_stat energy</div><div class="ttdef"><b>Definition:</b> <a href="energy_8cpp_source.html#l00045">energy.cpp:45</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a80f8ba49f0bf2dae363676c500062983"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a80f8ba49f0bf2dae363676c500062983">sumKernel</a></div><div class="ttdeci">__global__ void sumKernel(mmm1dgpu_real *data, int N)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00173">Mmm1dgpuForce_cuda.cu:173</a></div></div>
<div class="ttc" id="classSystemInterface_html_adf9fe800476549b004ea05f0aa3eaa70"><div class="ttname"><a href="classSystemInterface.html#adf9fe800476549b004ea05f0aa3eaa70">SystemInterface::box</a></div><div class="ttdeci">virtual Vector3 box()=0</div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a39ed5a85eb740f49186535d08af9f22d"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a39ed5a85eb740f49186535d08af9f22d">forcesKernel</a></div><div class="ttdeci">__global__ void forcesKernel(const __restrict__ mmm1dgpu_real *r, const __restrict__ mmm1dgpu_real *q, __restrict__ mmm1dgpu_real *force, int N, int pairs, int tStart=0, int tStop=-1)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00313">Mmm1dgpuForce_cuda.cu:313</a></div></div>
<div class="ttc" id="classSystemInterface_html"><div class="ttname"><a href="classSystemInterface.html">SystemInterface</a></div><div class="ttdef"><b>Definition:</b> <a href="SystemInterface_8hpp_source.html#l00027">SystemInterface.hpp:27</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_afc1d3fd48b33a5af56e8775cce8d5690"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#afc1d3fd48b33a5af56e8775cce8d5690">cudaSetDevice</a></div><div class="ttdeci">#define cudaSetDevice(d)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00027">Mmm1dgpuForce_cuda.cu:27</a></div></div>
<div class="ttc" id="mmm-common_8hpp_html_a0739e5d0cb51571f43e3a8aebc3d60a3"><div class="ttname"><a href="mmm-common_8hpp.html#a0739e5d0cb51571f43e3a8aebc3d60a3">C_2PI</a></div><div class="ttdeci">#define C_2PI</div><div class="ttdef"><b>Definition:</b> <a href="mmm-common_8hpp_source.html#l00032">mmm-common.hpp:32</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_ac8aa0a118c5866d8abe22a8716b48ba0"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#ac8aa0a118c5866d8abe22a8716b48ba0">atomicadd</a></div><div class="ttdeci">__device__ void atomicadd(float *address, float value)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00038">Mmm1dgpuForce_cuda.cu:38</a></div></div>
<div class="ttc" id="structCoulomb__parameters_html_a91e49bd10162ccc14beff4a244d905ec"><div class="ttname"><a href="structCoulomb__parameters.html#a91e49bd10162ccc14beff4a244d905ec">Coulomb_parameters::method</a></div><div class="ttdeci">CoulombMethod method</div><div class="ttdoc">Method to treat coulomb interaction. </div><div class="ttdef"><b>Definition:</b> <a href="interaction__data_8hpp_source.html#l00527">interaction_data.hpp:527</a></div></div>
<div class="ttc" id="structMMM1D__struct_html_a7e6588d0ac49a13043563570ad02516f"><div class="ttname"><a href="structMMM1D__struct.html#a7e6588d0ac49a13043563570ad02516f">MMM1D_struct::far_switch_radius_2</a></div><div class="ttdeci">double far_switch_radius_2</div><div class="ttdoc">square of the switching radius </div><div class="ttdef"><b>Definition:</b> <a href="mmm1d_8hpp_source.html#l00040">mmm1d.hpp:40</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_a93e697073d89f3497e682a636b46df6c"><div class="ttname"><a href="classMmm1dgpuForce.html#a93e697073d89f3497e682a636b46df6c">Mmm1dgpuForce::set_params</a></div><div class="ttdeci">void set_params(mmm1dgpu_real _boxz, mmm1dgpu_real _coulomb_prefactor, mmm1dgpu_real _maxPWerror, mmm1dgpu_real _far_switch_radius, int _bessel_cutoff, bool manual=false)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00259">Mmm1dgpuForce_cuda.cu:259</a></div></div>
<div class="ttc" id="EspressoSystemInterface_8hpp_html"><div class="ttname"><a href="EspressoSystemInterface_8hpp.html">EspressoSystemInterface.hpp</a></div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_af11b33a298a0e066c14e29efef8ca9b8"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#af11b33a298a0e066c14e29efef8ca9b8">coulomb_prefactor</a></div><div class="ttdeci">__constant__ mmm1dgpu_real coulomb_prefactor</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00062">Mmm1dgpuForce_cuda.cu:62</a></div></div>
<div class="ttc" id="interaction__data_8hpp_html"><div class="ttname"><a href="interaction__data_8hpp.html">interaction_data.hpp</a></div><div class="ttdoc">Various procedures concerning interactions between particles. </div></div>
<div class="ttc" id="Mmm1dgpuForce__cuda_8cu_html_a272b1ae74eb9f4f602daeec525860347"><div class="ttname"><a href="Mmm1dgpuForce__cuda_8cu.html#a272b1ae74eb9f4f602daeec525860347">far_switch_radius_2</a></div><div class="ttdeci">__constant__ mmm1dgpu_real far_switch_radius_2</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00059">Mmm1dgpuForce_cuda.cu:59</a></div></div>
<div class="ttc" id="Mmm1dgpuForce_8hpp_html_ada0f1179380dc888cd8b126c793158c7"><div class="ttname"><a href="Mmm1dgpuForce_8hpp.html#ada0f1179380dc888cd8b126c793158c7">mmm1dgpu_real</a></div><div class="ttdeci">float mmm1dgpu_real</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce_8hpp_source.html#l00027">Mmm1dgpuForce.hpp:27</a></div></div>
<div class="ttc" id="cuda__common__cuda_8cu_html_ad7833076f95fefc99fc8b326ff08700f"><div class="ttname"><a href="cuda__common__cuda_8cu.html#ad7833076f95fefc99fc8b326ff08700f">err</a></div><div class="ttdeci">cudaError_t err</div><div class="ttdef"><b>Definition:</b> <a href="cuda__common__cuda_8cu_source.html#l00058">cuda_common_cuda.cu:58</a></div></div>
<div class="ttc" id="classMmm1dgpuForce_html_aab29f6175a147363ebfe6bf8ae2de6f4"><div class="ttname"><a href="classMmm1dgpuForce.html#aab29f6175a147363ebfe6bf8ae2de6f4">Mmm1dgpuForce::computeEnergy</a></div><div class="ttdeci">void computeEnergy(SystemInterface &amp;s)</div><div class="ttdef"><b>Definition:</b> <a href="Mmm1dgpuForce__cuda_8cu_source.html#l00538">Mmm1dgpuForce_cuda.cu:538</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_aebb8dcc11953d78e620bbef0b9e2183.html">core</a></li><li class="navelem"><a class="el" href="dir_7dbd9d3bbc5ec1ce3207b09771479ec4.html">actor</a></li><li class="navelem"><a class="el" href="Mmm1dgpuForce__cuda_8cu.html">Mmm1dgpuForce_cuda.cu</a></li>
    <li class="footer">Generated on Fri Jun 12 2015 16:19:35 for ESPResSo 3.4-dev-1009-g69a2b86-dirty-git by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.9.1 </li>
  </ul>
</div>
</body>
</html>
